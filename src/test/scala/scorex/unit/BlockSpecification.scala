package scorex.unit

import org.scalatest.FunSuite
import scorex.account.PrivateKeyAccount
import scorex.block.{Block, BlockStub}
import scorex.consensus.nxt.{NxtBlockGenerationData, NxtBlockGenerationDataParser}
import scorex.consensus.qora.{QoraBlockGenerationFunctions, QoraBlockGenerationData}
import scorex.consensus.{ConsensusModuleNxt, ConsensusModuleQora}
import scorex.crypto.Base58
import scorex.transaction.{PaymentTransaction, Transaction}
import settings.Constants

import scala.util.Random

class BlockSpecification extends FunSuite {
  test("block with txs toBytes/parse roundtrip") {
    val reference = Array.fill(Block.REFERENCE_LENGTH)(Random.nextInt(100).toByte)
    val gen = new PrivateKeyAccount(reference)
    val gd = (Constants.ConsensusAlgo match {
      case ConsensusModuleNxt =>
        val gs = Array.fill(NxtBlockGenerationDataParser.GENERATOR_SIGNATURE_LENGTH)(Random.nextInt(100).toByte)
        NxtBlockGenerationData(Random.nextInt(Int.MaxValue)+1, gs)
      case ConsensusModuleQora =>
        val gb = Random.nextInt(Int.MaxValue)+1
        val gs = QoraBlockGenerationFunctions.calculateSignature(reference, gb, gen)
        QoraBlockGenerationData(gb, gs)
    }).asInstanceOf[Constants.ConsensusAlgo.kernelData]
    val bs = BlockStub(1, reference, System.currentTimeMillis(), gen, gd)

    val sender = new PrivateKeyAccount(reference.dropRight(2))
    val tx: Transaction = PaymentTransaction(sender, gen, 5, 1000, System.currentTimeMillis() - 5000)

    val b = Block(bs, Seq(tx), gen)

    val b2 = Block.parse(b.toBytes).get

    val at1 = b.transactions.head
    val at2 = b2.transactions.head

    assert(at1 == at2)
    assert(at1.amount == at2.amount)
    assert(b.isSignatureValid())
    assert(b2.isSignatureValid())
  }

  test("restoring from Base58 form"){
    if(Constants.ConsensusAlgo == ConsensusModuleNxt) {
      val b58 = "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"
      val b = Block.parse(Base58.decode(b58)).get
      assert(b.isSignatureValid())
    }
  }
}